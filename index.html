<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="description" content="A kanban task board with AI-powered prompts">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SnackBoard">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>SnackBoard - Quick Task Timer</title>
    <link rel="stylesheet" href="styles.css?v=3.1">
    <script>
        // Force cleanup of old service workers and caches BEFORE loading any other scripts
        (async () => {
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                    }
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                    console.log('SW cleanup complete');
                } catch (err) {
                    console.log('SW cleanup error:', err);
                }
            }
        })();
    </script>
</head>
<body>
    <!-- Active Timer Bar -->
    <div id="timerBar" class="timer-bar hidden">
        <div class="timer-content">
            <span class="timer-label">Working on:</span>
            <span id="timerTaskTitle" class="timer-task-title"></span>
            <span id="timerElapsed" class="timer-elapsed">00:00</span>
            <button id="timerStopBtn" class="timer-stop-btn">Stop</button>
        </div>
    </div>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <div class="app-container">
        <!-- Projects Sidebar -->
        <aside class="projects-sidebar" id="projectsSidebar">
            <div class="sidebar-header">
                <h2>Projects</h2>
                <button class="sidebar-close-btn" id="projectsCloseBtn" title="Close sidebar" style="display: none;">‚úï</button>
                <button class="sidebar-collapse-btn" id="projectsCollapseBtn" title="Collapse sidebar">‚óÄ</button>
            </div>
            <div class="projects-list">
                <div class="project-item active" data-project-id="all">
                    <div class="project-info">
                        <span class="project-name">All Projects</span>
                    </div>
                </div>
                <div id="projectsList"></div>
                <button id="newProjectBtn" class="new-project-btn">+ New Project</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Mobile App Bar -->
            <div class="mobile-app-bar">
                <button id="mobileProjectsBtn" class="mobile-app-bar-btn" title="Projects">‚ò∞</button>
                <h1 id="mobileTitle" class="mobile-app-bar-title">All Projects</h1>
                <div class="mobile-app-bar-actions">
                    <button id="mobileStatsBtn" class="mobile-app-bar-btn" title="Stats">üìä</button>
                    <button id="mobileNewTaskBtn" class="mobile-app-bar-btn mobile-new-task" title="New Task">+</button>
                </div>
            </div>

            <!-- Desktop Header with Filters -->
            <header class="board-header desktop-header">
                <div class="header-left">
                    <div class="header-top">
                        <h1 id="boardTitle">All Projects</h1>
                    </div>
                    <div class="header-buttons">
                        <span id="userEmail" class="user-email hidden"></span>
                        <button id="authBtn" class="auth-btn">Sign In</button>
                        <button id="importTasksBtn" class="import-tasks-btn hidden">Import Tasks</button>
                        <button id="newTaskBtn" class="new-task-btn">+ New Task</button>
                    </div>
                </div>
                <div class="filter-bar">
                    <div class="filter-group">
                        <label>Focuses:</label>
                        <div id="labelFilters" class="filter-chips-scroll">
                            <div class="filter-chips-container" id="labelFiltersContainer"></div>
                            <button id="addAreaBtn" class="add-area-btn">+ Add Focus</button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Size:</label>
                        <div id="sizeFilters" class="filter-chips"></div>
                    </div>
                    <div class="filter-group">
                        <label class="toggle-label">
                            <input type="checkbox" id="activeOnlyToggle" class="toggle-input">
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">Active Only</span>
                        </label>
                    </div>
                </div>
            </header>

            <!-- Mobile Filters (Collapsible) -->
            <div class="mobile-filters-container">
                <button id="mobileFiltersToggle" class="mobile-filters-toggle">Filters ‚ñº</button>
                <div id="mobileFiltersContent" class="mobile-filters-content">
                    <div class="mobile-filter-section">
                        <label>Focuses:</label>
                        <div class="filter-chips-scroll">
                            <div class="filter-chips-container" id="mobileLabelsContainer"></div>
                            <button id="mobileAddAreaBtn" class="add-area-btn">+ Add</button>
                        </div>
                    </div>
                    <div class="mobile-filter-section">
                        <label>Size:</label>
                        <div id="mobileSizeFilters" class="filter-chips"></div>
                    </div>
                    <div class="mobile-filter-section">
                        <label class="toggle-label">
                            <input type="checkbox" id="mobileActiveToggle" class="toggle-input">
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">Active Only</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Kanban Board -->
            <div class="kanban-board">
                <div class="kanban-column" data-column-id="backlog">
                    <div class="column-header">
                        <h3>Later</h3>
                        <span class="task-count">0</span>
                    </div>
                    <div class="column-tasks" id="backlog-tasks"></div>
                </div>
                <div class="kanban-column" data-column-id="ready">
                    <div class="column-header">
                        <h3>Next</h3>
                        <span class="task-count">0</span>
                    </div>
                    <div class="column-tasks" id="ready-tasks"></div>
                </div>
                <div class="kanban-column" data-column-id="doing">
                    <div class="column-header">
                        <h3>Now</h3>
                        <span class="task-count">0</span>
                    </div>
                    <div class="column-tasks" id="doing-tasks"></div>
                </div>
                <div class="kanban-column" data-column-id="done">
                    <div class="column-header">
                        <h3>Done</h3>
                        <span class="task-count">0</span>
                    </div>
                    <div class="column-tasks" id="done-tasks"></div>
                </div>
            </div>
        </main>

        <!-- Stats Sidebar -->
        <aside class="stats-sidebar" id="statsSidebar">
            <button class="stats-toggle-btn" id="statsToggleBtn">
                <span class="stats-toggle-icon">üìä</span>
            </button>
            <div class="stats-header">
                <h2>Today's Stats</h2>
                <button class="sidebar-collapse-btn" id="statsCollapseBtn" title="Collapse sidebar">‚ñ∂</button>
                <button class="stats-close-btn" id="statsCloseBtn">√ó</button>
            </div>
            <div class="stats-content">
                <div class="stat-card">
                    <div class="stat-label">Total Time Today</div>
                    <div id="totalTimeToday" class="stat-value">0m</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Estimate vs Actual</div>
                    <div id="estimateVsActual" class="stat-value">-</div>
                </div>
                <div class="stat-section">
                    <h3>By Focus</h3>
                    <div id="statsByLabel" class="stats-list"></div>
                </div>
                <div class="stat-section">
                    <h3>By Project</h3>
                    <div id="statsByProject" class="stats-list"></div>
                </div>
                <div id="selectedProjectStats" class="stat-section hidden">
                    <h3>Selected Project</h3>
                    <div id="projectStatsContent" class="stats-list"></div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Task Detail Modal -->
    <div id="taskModal" class="modal hidden">
        <div class="modal-content wizard-modal">
            <div class="modal-header">
                <h2 id="modalTitle">Create Task</h2>
                <button class="modal-close">&times;</button>
            </div>
            
            <!-- Wizard Progress -->
            <div class="wizard-progress">
                <div class="wizard-step" data-step="1">
                    <div class="wizard-step-number">1</div>
                    <div class="wizard-step-label">Basics</div>
                </div>
                <div class="wizard-step-line"></div>
                <div class="wizard-step" data-step="2">
                    <div class="wizard-step-number">2</div>
                    <div class="wizard-step-label">Details</div>
                </div>
                <div class="wizard-step-line"></div>
                <div class="wizard-step" data-step="3">
                    <div class="wizard-step-number">3</div>
                    <div class="wizard-step-label">Organize</div>
                </div>
                <div class="wizard-step-line"></div>
                <div class="wizard-step" data-step="4">
                    <div class="wizard-step-number">4</div>
                    <div class="wizard-step-label">AI Prompt</div>
                </div>
            </div>

            <div class="modal-body wizard-body">
                <!-- Step 1: Basics -->
                <div class="wizard-panel" data-panel="1">
                    <div class="wizard-panel-header">
                        <h3>Let's start with the basics</h3>
                        <p>What task do you want to create?</p>
                    </div>
                    <div class="wizard-panel-content">
                        <div class="form-group">
                            <label>Task Title *</label>
                            <input type="text" id="taskTitle" placeholder="e.g., Fix login bug" autofocus>
                        </div>
                        <div class="form-group">
                            <label>Task Type</label>
                            <div class="wizard-toggle-group">
                                <button type="button" class="wizard-toggle-btn active" data-prompt-type="timed" tabindex="0">
                                    <span class="toggle-icon">‚è±Ô∏è</span>
                                    <span class="toggle-label">Timed Task</span>
                                    <span class="toggle-desc">Track time spent</span>
                                </button>
                                <button type="button" class="wizard-toggle-btn" data-prompt-type="prompt" tabindex="0">
                                    <span class="toggle-icon">‚ú®</span>
                                    <span class="toggle-label">AI Prompt</span>
                                    <span class="toggle-desc">No timer needed</span>
                                </button>
                            </div>
                            <input type="checkbox" id="taskIsPromptOnly" style="display: none;">
                        </div>
                    </div>
                </div>

                <!-- Step 2: Details -->
                <div class="wizard-panel" data-panel="2" style="display: none;">
                    <div class="wizard-panel-header">
                        <h3>Set your timing</h3>
                        <p>How long will this take?</p>
                    </div>
                    <div class="wizard-panel-content">
                        <div class="form-group">
                            <label>Size Estimate</label>
                            <div class="wizard-size-grid">
                                <button type="button" class="wizard-size-btn" data-size="1">
                                    <span class="size-number">1</span>
                                    <span class="size-label">min</span>
                                </button>
                                <button type="button" class="wizard-size-btn" data-size="5">
                                    <span class="size-number">5</span>
                                    <span class="size-label">min</span>
                                </button>
                                <button type="button" class="wizard-size-btn" data-size="15">
                                    <span class="size-number">15</span>
                                    <span class="size-label">min</span>
                                </button>
                                <button type="button" class="wizard-size-btn" data-size="30">
                                    <span class="size-number">30</span>
                                    <span class="size-label">min</span>
                                </button>
                            </div>
                            <select id="taskSize" style="display: none;">
                                <option value="1">1 min</option>
                                <option value="5">5 min</option>
                                <option value="15">15 min</option>
                                <option value="30">30 min</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Custom Estimate (optional)</label>
                            <input type="number" id="taskEstimate" min="1" placeholder="Enter minutes...">
                        </div>
                        <input type="number" id="taskActual" style="display: none;" readonly>
                    </div>
                </div>

                <!-- Step 3: Organize -->
                <div class="wizard-panel" data-panel="3" style="display: none;">
                    <div class="wizard-panel-header">
                        <h3>Organize your task</h3>
                        <p>Where does this task belong?</p>
                    </div>
                    <div class="wizard-panel-content">
                        <div class="form-group">
                            <label>Project</label>
                            <select id="taskProject">
                                <option value="">No project</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Starting Column</label>
                            <div class="wizard-column-grid">
                                <button type="button" class="wizard-column-btn" data-column="backlog" tabindex="0">
                                    <span class="column-icon">üì•</span>
                                    <span class="column-name">Later</span>
                                </button>
                                <button type="button" class="wizard-column-btn" data-column="ready" tabindex="0">
                                    <span class="column-icon">üìã</span>
                                    <span class="column-name">Next</span>
                                </button>
                                <button type="button" class="wizard-column-btn active" data-column="doing" tabindex="0">
                                    <span class="column-icon">üöÄ</span>
                                    <span class="column-name">Now</span>
                                </button>
                                <button type="button" class="wizard-column-btn" data-column="done" tabindex="0">
                                    <span class="column-icon">‚úÖ</span>
                                    <span class="column-name">Done</span>
                                </button>
                            </div>
                            <select id="taskColumn" style="display: none;">
                                <option value="backlog">Later</option>
                                <option value="ready">Next</option>
                                <option value="doing" selected>Now</option>
                                <option value="done">Done</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Focus Areas (optional)</label>
                            <div id="taskLabels" class="labels-input"></div>
                            <input type="text" id="newLabelInput" placeholder="Type and press Enter..." class="new-label-input">
                        </div>
                    </div>
                </div>

                <!-- Step 4: AI Prompt & Notes -->
                <div class="wizard-panel" data-panel="4" style="display: none;">
                    <div class="wizard-panel-header">
                        <h3>Add AI prompt and notes</h3>
                        <p>Optional details for your task</p>
                    </div>
                    <div class="wizard-panel-content">
                        <div class="form-group" id="aiPromptGroup">
                            <label>AI Prompt</label>
                            <textarea id="taskAiPrompt" rows="6" placeholder="Enter your AI prompt here..."></textarea>
                            <button type="button" class="copy-prompt-btn" id="copyPromptBtn">üìã Copy Prompt</button>
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea id="taskNotes" rows="4" placeholder="Additional notes..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wizard Navigation -->
            <div class="wizard-footer">
                <button id="deleteTaskBtn" class="btn-danger wizard-delete" style="display: none;">Delete Task</button>
                <div class="wizard-nav">
                    <button id="wizardBackBtn" class="btn-secondary" style="display: none;">‚Üê Back</button>
                    <button id="wizardNextBtn" class="btn-primary">Next ‚Üí</button>
                    <button id="wizardSaveBtn" class="btn-primary" style="display: none;">Create Task</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Detail Modal -->
    <div id="projectModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="projectModalTitle">Project Details</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" id="projectName" placeholder="Project name...">
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <div class="color-picker">
                        <input type="color" id="projectColor" value="#6366f1">
                    </div>
                </div>
                <div class="form-group">
                    <label>Primary Focus</label>
                    <select id="projectPrimaryArea">
                        <option value="">No Focus</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="projectNotes" rows="4" placeholder="Project notes..."></textarea>
                </div>
                <div class="modal-actions">
                    <button id="deleteProjectBtn" class="btn-danger">Delete Project</button>
                    <div class="modal-actions-right">
                        <button id="cancelProjectBtn" class="btn-secondary">Cancel</button>
                        <button id="saveProjectBtn" class="btn-primary">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Area Menu Modal -->
    <div id="areaMenuModal" class="context-menu hidden">
        <div class="context-menu-item" id="renameAreaMenuItem">Rename Focus</div>
        <div class="context-menu-item danger" id="deleteAreaMenuItem">Delete Focus</div>
    </div>

    <!-- Add Area Modal -->
    <div id="addAreaModal" class="modal hidden">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Add New Focus</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Focus Name</label>
                    <input type="text" id="newAreaName" placeholder="e.g., Coding, Studio, Design...">
                </div>
                <div class="modal-actions">
                    <div class="modal-actions-right">
                        <button id="cancelAddAreaBtn" class="btn-secondary">Cancel</button>
                        <button id="saveAddAreaBtn" class="btn-primary">Add Focus</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rename Area Modal -->
    <div id="renameAreaModal" class="modal hidden">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Rename Focus</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Focus Name</label>
                    <input type="text" id="renameAreaName" placeholder="New focus name...">
                </div>
                <div class="modal-actions">
                    <div class="modal-actions-right">
                        <button id="cancelRenameAreaBtn" class="btn-secondary">Cancel</button>
                        <button id="saveRenameAreaBtn" class="btn-primary">Rename</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Tasks Modal -->
    <div id="importTasksModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import Tasks</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Paste CSV Content</label>
                    <textarea id="importCSV" rows="10" placeholder="Title,Focus,Size,Column,Type&#10;Buy domain,CRM,5m,Next&#10;Write AI prompt,Studio,5m,Later,prompt&#10;Design hero section,Studio,15m,Later"></textarea>
                </div>
                <div class="import-instructions">
                    <strong>Format:</strong> First line must be: <code>Title,Focus,Size,Column</code><br>
                    <strong>Optional:</strong> Add <code>,Type</code> column (use "prompt" for prompt-only tasks)<br>
                    <strong>Size:</strong> 1m, 5m, 15m, or 30m<br>
                    <strong>Column:</strong> Later, Next, Now, or Done<br>
                    All tasks will be added to the current project.
                </div>
                <div id="importResult" class="import-result hidden"></div>
                <div class="modal-actions">
                    <div class="modal-actions-right">
                        <button id="cancelImportBtn" class="btn-secondary">Cancel</button>
                        <button id="executeImportBtn" class="btn-primary">Import Tasks</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content auth-modal">
            <div class="auth-header">
                <h2>Sign in to SnackBoard</h2>
            </div>
            <div class="auth-body">
                <div class="auth-form-group">
                    <input type="email" id="authEmail" placeholder="Email" autocomplete="email">
                </div>
                <div class="auth-form-group">
                    <input type="password" id="authPassword" placeholder="Password" autocomplete="current-password">
                </div>
                <button id="signInBtn" class="btn-auth-primary">Continue</button>
                <div class="auth-divider">
                    <span>New to SnackBoard?</span>
                </div>
                <button id="signUpBtn" class="btn-auth-secondary">Create an account</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js?v=3.1"></script>
    <script src="app.js?v=3.1"></script>
    <script>
        // Register new service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/snackboard/service-worker.js?v=3.1');
                    console.log('SW registered:', registration);
                    await registration.update();
                } catch (err) {
                    console.log('SW setup failed:', err);
                }
            });
        }
    </script>
</body>
</html>
